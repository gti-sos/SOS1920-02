<script>
    import {
        onMount
    } from "svelte";
 
    import Table from "sveltestrap/src/Table.svelte";
    import Button from "sveltestrap/src/Button.svelte";
	import { Pagination, PaginationItem, PaginationLink } from 'sveltestrap';
	import Input from "sveltestrap/src/Input.svelte";
	import FormGroup from "sveltestrap/src/FormGroup.svelte";
 
    let tourism = [];
    let newTourism = {
        province: "",
        year: 0.0,
        traveller: 0.0,
		overnightstay: 0.0,
		averagestay: 0.0
		
    };
	//Variables para paginación
	let numeroRecursos = 10;
	let offset = 0;
	let currentPage = 1; 
	let moreData = true; 
	
	//Variables para busqueda
	let campo = "";
	let valor = "";
 
    onMount(getTourism);
	
	
    async function getTourism() {
 
        console.log("Fetching rural-tourism-stats...");
        const res = await fetch("/api/v1/rural-tourism-stats?offset="  + numeroRecursos * offset + "&limit=" + numeroRecursos);
		const resNext = await fetch("/api/v1/rural-tourism-stats?offset="  + numeroRecursos * (offset + 1) + "&limit=" + numeroRecursos);
 
        if (res.ok  && resNext.ok) {
            console.log("Ok:");
            const json = await res.json();
			const jsonNext = await resNext.json();
            tourism = json;
			
			if (jsonNext.length == 0) {
				moreData = false;
			} else {
				moreData = true;
			}
			
            console.log("Received " + tourism.length + " rural-tourism-stats.");
        } else {
            console.log("ERROR!");
        }
    }
	function incrementOffset(valor) {
		offset += valor;
		currentPage += valor;
		getTourism();
	}
 
  	async function insertTourism() {
	  
        console.log("Inserting new data..." + JSON.stringify(newTourism));
 
        const res = await fetch("/api/v1/rural-tourism-stats", {
            method: "POST",
            body: JSON.stringify(newTourism),
            headers: {
                "Content-Type": "application/json"
            }
        }).then(function (res) {
            getTourism();
			let newTourism = {
        		province: "",
        		year: 0.0,
        		traveller: 0.0,
				overnightstay: 0.0,
				averagestay: 0.0
		
    };
        });
 
    }
    async function deleteTourism(province, year) {
        const res = await fetch("/api/v1/rural-tourism-stats/" + province +"/" + year, {
            method: "DELETE"
        }).then(function (res) {
            getTourism();
        });
    }
	async function deleteAllTourism() {
        const res = await fetch("/api/v1/rural-tourism-stats/", {
            method: "DELETE"
        }).then(function (res) {
            getTourism();
        });
    }
	async function loadInitialData() {
        const res = await fetch("/api/v1/rural-tourism-stats/loadInitialData", {
            method: "GET"
        }).then(function (res) {
            getTourism();
        });
    }
	
	async function busqueda(campo, valor) {
		
		console.log("Searching data: " + campo + " and " + valor);
		
		var url = "/api/v1/rural-tourism-stats";
		
		if (campo != "" && valor != "") {
			url = url + "?" + campo + "=" + valor; 
		}
		
		console.log(url)
		
		const res = await fetch(url);
		
		if (res.ok) {
			console.log("Ok:");
			const json = await res.json();
			tourism = json;			
			console.log("Found " + tourism.length + " rural-tourism-stats.");
		} else {
			console.log("ERROR!");
		}
	}
	
</script>
 
<main>
	<h2>Turismo rural</h2>
 	<div style="text-align:center;padding-bottom: 3%;">
		<Button outline  color="primary" on:click={loadInitialData}>Inicializar</Button>
		<Button outline  color="danger" on:click={deleteAllTourism}><i class="fa fa-trash" aria-hidden="true"></i> Eliminar todo</Button>
	</div>
	
    {#await tourism}
        Loading datas...
    {:then tourism}
	
	
		<FormGroup  style="width:25%;"> 
			<label>Selecciona el campo por el que buscar:</label>
			<Input type="select" name="inputCampo" id="inputCampo" bind:value="{campo}">
				<option disabled selected></option>
				<option value="province">Provincia</option>
				<option value="year">Año</option>
				<option value="traveller">Viajero</option>
				<option value="overnightstay">Pernoctación</option>
				<option value="averagestay">Estancia media</option>
			</Input>
		</FormGroup>
				
		<FormGroup style="width:25%;">
			<label>Valor del campo:</label>
			<Input type="text"  name="inputValor" id="inputValor" bind:value="{valor}"></Input>
		</FormGroup>

		<Button style="margin-bottom:3%;" outline color="primary" on:click="{busqueda(campo, valor)}" class="button-search" >Buscar </Button>
			
	
	
	
        <Table bordered>
            <thead>
                <tr>
                    <th>Provincia</th>
                	<th>Año</th>
                	<th>Viajero</th>
                	<th>Pernoctación</th>
					<th>Estancia media</th>
					<th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {#each tourism as tou}
                    <tr>
						<td>
                        	<a href="#/rural-tourism-stats/{tou.province}/{tou.year}">{tou.province}</a>
						</td>
                        <td>{tou.year}</td>
                        <td>{tou.traveller}</td>
						<td>{tou.overnightstay}</td>
                        <td>{tou.averagestay}</td>
                        <td><Button outline color="danger" on:click="{deleteTourism(tou.province,tou.year)}"><i class="fa fa-trash" aria-hidden="true"></i> Eliminar</Button></td>
                    </tr>
                {/each}
            </tbody>
        </Table>
		<h3>Añadir nuevo dato:</h3>
		<Table style="background-color:#EAEEF0;">
			<tr>
				<td><strong>Provincia:</strong> <input bind:value="{newTourism.province}"></td>
				<td><strong>Año:</strong> <input type="number" bind:value="{newTourism.year}"></td>
				<td><strong>Viajero:</strong> <input type="number" bind:value="{newTourism.traveller}"></td>
				<td><strong>Pernoctación:</strong> <input type="number" bind:value="{newTourism.overnightstay}"></td>
				<td><strong>Estancia media:</strong> <input type="number" bind:value="{newTourism.averagestay}"></td>
				<td><strong>Acción:</strong> <Button color="primary" on:click={insertTourism}>Añadir</Button> </td>
			</tr>
		</Table>
	
    {/await}
 	<Pagination ariaLabel="Cambiar de página">


		<PaginationItem class="{currentPage === 1 ? 'disabled' : ''}">
		  <PaginationLink previous href="#/rural-tourism-stats" on:click="{() => incrementOffset(-1)}" />
		</PaginationItem>
		
		<!-- If we are not in the first page-->
		{#if currentPage != 1}
		<PaginationItem>
			<PaginationLink href="#/rural-tourism-stats" on:click="{() => incrementOffset(-1)}" >{currentPage - 1}</PaginationLink>
		</PaginationItem>
		{/if}
		<PaginationItem active>
			<PaginationLink href="#/rural-tourism-stats" >{currentPage}</PaginationLink>
		</PaginationItem>

		<!-- If there are more elements-->
		{#if moreData}
		<PaginationItem >
			<PaginationLink href="#/rural-tourism-stats" on:click="{() => incrementOffset(1)}">{currentPage + 1}</PaginationLink>
		</PaginationItem>
		{/if}

		<PaginationItem class="{moreData ? '' : 'disabled'}">
		  <PaginationLink next href="#/rural-tourism-stats" on:click="{() => incrementOffset(1)}"/>
		</PaginationItem>

	</Pagination>
 
</main>